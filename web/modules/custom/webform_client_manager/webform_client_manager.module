<?php

/**
 * @file
 * Contains webform_client_manager.module.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\webform\WebformInterface;
use Drupal\user\UserInterface;
use Drupal\Core\Url;
use Symfony\Component\HttpFoundation\RedirectResponse;

/**
 * Implements hook_webform_access().
 */
function webform_client_manager_webform_access(WebformInterface $webform, $operation, AccountInterface $account) {
  // Only control access for 'create' operation (submitting the form).
  if ($operation !== 'create') {
    return AccessResult::neutral();
  }

  // Allow admin users full access.
  if ($account->hasPermission('administer clients')) {
    return AccessResult::neutral();
  }

  /** @var \Drupal\webform_client_manager\WebformClientManager $manager */
  $manager = \Drupal::service('webform_client_manager.manager');

  // Check if this is a module webform.
  if (strpos($webform->label(), 'Module') !== 0) {
    return AccessResult::neutral();
  }

  // Check if user has access to this webform.
  if ($manager->userHasAccessToWebform($webform->id())) {
    return AccessResult::allowed()->cachePerUser();
  }

  return AccessResult::forbidden('User does not have access to this webform module.')
    ->cachePerUser();
}

/**
 * Implements hook_user_insert().
 */
function webform_client_manager_user_insert(UserInterface $account) {
  // Assign member role to new users (except uid 1).
  if ($account->id() != 1) {
    $account->addRole('member');
    $account->save();
  }
}

/**
 * Implements hook_user_login().
 */
function webform_client_manager_user_login(UserInterface $account) {
  // Set destination for members to dashboard after login.
  if ($account->hasRole('member') && !$account->hasRole('administrator')) {
    // Store the redirect in the session for the event subscriber.
    $request_stack = \Drupal::service('request_stack');
    $request = $request_stack->getCurrentRequest();
    if ($request && !$request->query->has('destination')) {
      $request->query->set('destination', '/dashboard');
    }
  }
}

/**
 * Implements hook_theme().
 */
function webform_client_manager_theme($existing, $type, $theme, $path) {
  return [
    'webform_client_dashboard' => [
      'variables' => [
        'client_name' => NULL,
        'modules' => [],
        'total_modules' => 0,
        'completed_modules' => 0,
        'progress_percentage' => 0,
      ],
    ],
  ];
}
