<?php

/**
 * @file
 * Contains client_dashboard.module.
 */

use Drupal\webform\Entity\WebformSubmission;

/**
 * Implements hook_theme().
 */
function client_dashboard_theme($existing, $type, $theme, $path) {
  return [
    'client_dashboard' => [
      'variables' => [
        'client_name' => NULL,
        'modules' => [],
        'modules_view' => NULL,
        'total_modules' => 0,
        'completed_modules' => 0,
        'progress_percentage' => 0,
        'analysis_available' => FALSE,
        'all_modules_completed' => FALSE,
        'report_statuses' => [],
      ],
    ],
    'client_dashboard_reports' => [
      'variables' => [
        'client_name' => NULL,
        'report_statuses' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_ENTITY_TYPE_update() for webform_submission.
 */
function client_dashboard_webform_submission_update(WebformSubmission $submission) {
  // Check if the submission's completed field changed to > 0.
  if ($submission->get('completed')->value > 0) {
    // Get the user ID from the submission.
    $uid = $submission->getOwnerId();

    // Get the auto report processor service.
    $auto_processor = \Drupal::service('client_dashboard.auto_report_processor');

    // Check if we should auto-process for this user.
    if ($auto_processor->shouldAutoProcess($uid)) {
      // Queue all enabled reports.
      $auto_processor->queueAllReports($uid);
    }
  }
}
